<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø¶ÙŠ â€“ Professional History Taking</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#0b1224;       /* deeper */
      --card:#111b33;        /* slate-900-ish */
      --muted:#94a3b8;       /* slate-400 */
      --text:#e5e7eb;        /* gray-200 */
      --brand:#22c55e;       /* green-500 */
      --brand-2:#06b6d4;     /* cyan-500 */
      --danger:#ef4444;
      --ok:#10b981;
      --border:#1f2a44;
      --chip:#1e293b;
      --chip-hover:#0f172a;
      --shadow: 0 8px 30px rgba(0,0,0,.25);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", sans-serif;
      background: radial-gradient(1200px 700px at 85% -10%, #0a6 0%, transparent 55%) fixed,
                  radial-gradient(900px 600px at -10% 110%, #09c 0%, transparent 50%) fixed,
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:20px; display:flex; align-items:center; gap:14px; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:42px; height:42px; border-radius:12px; background:
        conic-gradient(from 210deg at 70% 30%, #22c55e, #06b6d4);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.08), var(--shadow);
    }
    h1{font-size:1.2rem; margin:0}
    .wrap{
      display:grid; grid-template-columns: 1.5fr 1fr; gap:18px; padding:0 20px 24px;
    }
    @media (max-width:1100px){ .wrap{grid-template-columns:1fr} }
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 30%) , var(--panel);
      border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);
    }
    .note-panel{position:sticky; top:16px; align-self:start}
    .section{margin:14px 0; padding:14px; border:1px dashed var(--border); border-radius:12px; background: rgba(255,255,255,.02)}
    .section h3{margin:0 0 10px; font-size:1.05rem}
    .row{display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px}
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px;
      background:var(--chip); border:1px solid var(--border); cursor:pointer; transition:.2s;
    }
    .chip:hover{background:var(--chip-hover)}
    .chip input{accent-color:var(--brand); transform:scale(1.2)}
    .muted{color:var(--muted); font-size:.9rem}
    .divider{height:1px; background:linear-gradient(90deg, transparent, #1f2a44, transparent); margin:14px 0}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button, .btn{
      background:linear-gradient(180deg, rgba(255,255,255,.07), transparent), var(--card);
      color:var(--text); border:1px solid var(--border); padding:12px 14px; border-radius:12px; cursor:pointer;
      transition:.2s; font-weight:600;
    }
    button.primary{ background:linear-gradient(180deg, rgba(255,255,255,.12), transparent), #14532d; border-color:#1d4ed8; }
    button:hover, .btn:hover{transform:translateY(-1px); box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .grid-two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){ .grid-two{grid-template-columns:1fr} }
    .age-card{
      display:flex; gap:12px; align-items:center; background:var(--card); padding:14px; border-radius:12px;
      border:1px solid var(--border);
    }
    input[type="number"], select{
      width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); background:#0b1326; color:var(--text);
      outline:none; transition:.2s;
    }
    select{cursor:pointer}
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0b1326; color:var(--text);
    }
    .hidden{display:none !important}
    .note{
      white-space:pre-wrap; background:linear-gradient(180deg, rgba(255,255,255,.03), transparent), var(--card);
      border:1px solid var(--border); border-radius:12px; padding:14px; min-height:320px; font-family:ui-monospace, "Cascadia Code", "Fira Code", monospace;
    }
    .kicker{color:#a7f3d0; font-weight:700}
    .stepper{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 12px}
    .step{
      padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:#0b1224; color:var(--muted);
      font-weight:600; font-size:.9rem
    }
    .step.active{color:#10b981; border-color:#10b981}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; font-size:.8rem; border:1px solid var(--border); background:#0e1a32; color:#93c5fd}
    .footer{padding:16px 20px; color:var(--muted); font-size:.9rem}
    .warn{color:#fca5a5}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø¶ÙŠ â€“ <span class="kicker">Professional</span></h1>
        <div class="muted">ÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø¨Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª â€“ Ø§Ù„Ù†ÙˆØªØ© ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ğŸ‘Œ</div>
      </div>
    </div>
    <div><span class="tag">HTML+CSS+JS</span></div>
  </header>

  <div class="wrap">
    <!-- LEFT: FORM -->
    <main class="panel">
      <div class="stepper" id="stepper"></div>

      <!-- STEP 1: AGE GATE -->
      <section class="section" id="step-age">
        <h3>Ù¡) Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± Ø£ÙˆÙ„Ù‹Ø§</h3>
        <div class="age-card">
          <label for="age"><strong>Ø§Ù„Ø¹Ù…Ø± (Ø¨Ø§Ù„Ø³Ù†ÙˆØ§Øª):</strong></label>
          <input id="age" type="number" min="0" max="120" placeholder="Ù…Ø«Ø§Ù„: 35" />
          <button id="confirmAge" class="primary">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ø±</button>
        </div>
        <div id="ageWarn" class="muted warn hidden">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù…Ø± Ù…Ù† 0 Ø¥Ù„Ù‰ 120.</div>
      </section>

      <!-- STEP 2+: DYNAMIC SECTIONS -->
      <div id="dynamicSections" class="hidden"></div>

      <div class="divider"></div>
      <div class="actions hidden" id="finalActions">
        <button id="copyNote">Ù†Ø³Ø® Ø§Ù„Ù†ÙˆØªØ©</button>
        <button id="downloadTxt">ØªØ­Ù…ÙŠÙ„ ÙƒÙ…Ù„Ù TXT</button>
        <button id="printNote">Ø·Ø¨Ø§Ø¹Ø©</button>
        <div class="muted">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ÙˆØªØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£ÙŠ Ø®ÙŠØ§Ø±.</div>
      </div>
    </main>

    <!-- RIGHT: NOTE -->
    <aside class="panel note-panel">
      <h3>Ø§Ù„Ù†ÙˆØªØ© Ø§Ù„Ø³Ø±ÙŠØ±ÙŠØ© (Autoâ€‘Generated)</h3>
      <div class="note" id="noteBox">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…Ø± Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙˆÙ„ÙŠØ¯â€¦</div>
    </aside>
  </div>

  <div class="footer">
    ØµÙ†Ø¹ Ù„ÙŠÙ„Ø§Ø¦Ù… Ù…Ø´Ø§Ø±ÙŠØ¹Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©. Ù„Ø§ ÙŠØ¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„Ø§ ÙŠØ­ØªØ§Ø¬ Ø¥Ù†ØªØ±Ù†Øª. ğŸ”¨ğŸ¤–ğŸ”§
  </div>

  <script>
    // ============ State ============
    const state = {
      age: null,
      answers: {},
    };

    // ============ Utilities ============
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];
    const byId = id => document.getElementById(id);

    function kebab(str){ return str.toLowerCase().replace(/\s+/g,'-'); }

    function ensureArray(x){ return Array.isArray(x) ? x : (x ? [x] : []); }

    // Toggle "None" behavior inside checkbox groups
    function handleNoneBehavior(container){
      container.addEventListener('change', (e)=>{
        const t = e.target;
        if(t.type !== 'checkbox') return;
        const group = t.closest('[data-group]');
        if(!group) return;
        const none = group.querySelector('input[data-none]');
        const others = [...group.querySelectorAll('input[type="checkbox"]:not([data-none])')];
        if(t.hasAttribute('data-none') && t.checked){
          // Uncheck others
          others.forEach(c=>c.checked=false);
        } else if(!t.hasAttribute('data-none') && t.checked){
          if(none) none.checked=false;
        }
        renderNote();
      });
    }

    // ============ Schema ============
    // Every section declares its own summarize(answers) -> string
    const SCHEMA = [
      {
        id: "demographics",
        title: "Ù¢) Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ§ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©",
        questions: [
          {
            key:"gender",
            label:"Ø§Ù„Ø¬Ù†Ø³",
            type:"radio",
            options:[
              {value:"Ø°ÙƒØ±", label:"Ø°ÙƒØ±"},
              {value:"Ø£Ù†Ø«Ù‰", label:"Ø£Ù†Ø«Ù‰"},
              {value:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯", label:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}
            ],
            default:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
          },
          {
            key:"chief",
            label:"Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
            type:"select",
            options:[
              "Ø£Ù„Ù… ØµØ¯Ø±ÙŠ","Ø¶ÙŠÙ‚ ØªÙ†ÙØ³","Ø­Ù…Ù‘Ù‰","Ø³Ø¹Ø§Ù„","Ø£Ù„Ù… Ø¨Ø·Ù†ÙŠ","ØµØ¯Ø§Ø¹",
              "Ø¯ÙˆØ®Ø©","Ø®ÙÙ‚Ø§Ù†","Ù‚ÙŠØ¡/ØºØ«ÙŠØ§Ù†","Ø¥Ø³Ù‡Ø§Ù„","Ø£Ù„Ù… Ù…ÙØ§ØµÙ„","Ù…ØªØ§Ø¨Ø¹Ø© Ø±ÙˆØªÙŠÙ†ÙŠØ©","Ø£Ø®Ø±Ù‰"
            ],
            withOther:true
          },
          {
            key:"onset",
            label:"Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶",
            type:"radio",
            options:["Ø­Ø§Ø¯","ØªØ­Øª Ø­Ø§Ø¯","Ù…Ø²Ù…Ù†","ØºÙŠØ± Ù…Ø­Ø¯Ø¯"],
            default:"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"
          },
          {
            key:"severity",
            label:"Ø´Ø¯Ø© Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶",
            type:"radio",
            options:["Ø®ÙÙŠÙØ©","Ù…ØªÙˆØ³Ø·Ø©","Ø´Ø¯ÙŠØ¯Ø©"],
            default:"Ù…ØªÙˆØ³Ø·Ø©"
          }
        ],
        summarize(ans){
          const g = ans.gender || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          const c = ans.chief === "Ø£Ø®Ø±Ù‰" ? (ans.chief_other || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯") : (ans.chief || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");
          const onset = ans.onset || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          const sev = ans.severity || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          return `Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ§/Ø§Ù„Ø´ÙƒÙˆÙ‰:
- Ø§Ù„Ø¬Ù†Ø³: ${g}
- Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: ${c}
- Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: ${onset} | Ø§Ù„Ø´Ø¯Ø©: ${sev}`;
        }
      },
      {
        id:"pmh",
        title:"Ù£) Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø© (PMH)",
        questions:[
          {
            key:"pmh",
            label:"Ø§Ø®ØªØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©",
            type:"checkbox",
            options:[
              "Ù„Ø§ ÙŠÙˆØ¬Ø¯",
              "Ø³ÙƒØ±ÙŠ","Ø¶ØºØ· Ø¯Ù…","Ø±Ø¨Ùˆ","Ù‚ØµÙˆØ±/ÙØ±Ø· Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ©","Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ÙŠØ©","Ø£Ù…Ø±Ø§Ø¶ ÙƒÙ„ÙˆÙŠØ© Ù…Ø²Ù…Ù†Ø©",
              "ØµØ±Ø¹","Ø§Ø±ØªÙØ§Ø¹ Ø¯Ù‡ÙˆÙ†","Ù‚Ø±Ø­Ø©/Ø§Ø±ØªØ¬Ø§Ø¹ Ù…Ø¹Ø¯ÙŠ","Ø£Ù…Ø±Ø§Ø¶ Ù†ÙØ³ÙŠØ©","Ø£Ø®Ø±Ù‰"
            ],
            withOther:true,
            hasNone:true
          }
        ],
        summarize(ans){
          const list = ensureArray(ans.pmh);
          if(list.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯")) return "PMH: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø© Ù…Ø¹Ø±ÙˆÙØ©.";
          const other = ans.pmh_other ? `ØŒ Ø£Ø®Ø±Ù‰: ${ans.pmh_other}` : "";
          return `PMH: ${list.join("ØŒ ")}${other}.`;
        }
      },
      {
        id:"meds",
        title:"Ù¤) Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©",
        questions:[
          {
            key:"meds",
            label:"Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©",
            type:"checkbox",
            options:[
              "Ù„Ø§ ÙŠÙˆØ¬Ø¯",
              "Ø£Ø¯ÙˆÙŠØ© Ø¶ØºØ·","Ø£Ø¯ÙˆÙŠØ© Ø³ÙƒØ± (ÙÙ…ÙˆÙŠØ©)","Ø£Ù†Ø³ÙˆÙ„ÙŠÙ†","Ù…Ø¶Ø§Ø¯Ø§Øª ØªØ®Ø«Ø±",
              "Ù…ÙˆØ³Ø¹Ø§Øª/Ø¨Ø®Ø§Ø®Ø§Øª Ø±Ø¨Ùˆ","Ù…Ø³ÙƒÙ†Ø§Øª Ù…Ù†ØªØ¸Ù…Ø©","Ù…Ø¶Ø§Ø¯Ø§Øª Ø§ÙƒØªØ¦Ø§Ø¨/Ù‚Ù„Ù‚","Ù…ÙƒÙ…Ù„Ø§Øª","Ø£Ø®Ø±Ù‰"
            ],
            withOther:true,
            hasNone:true
          },
          {
            key:"adherence",
            label:"Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ",
            type:"radio",
            options:["Ø¬ÙŠØ¯","Ù…ØªÙˆØ³Ø·","Ø¶Ø¹ÙŠÙ","ØºÙŠØ± Ù…ÙÙ‚ÙŠÙ‘Ù…"],
            default:"ØºÙŠØ± Ù…ÙÙ‚ÙŠÙ‘Ù…"
          }
        ],
        summarize(ans){
          const meds = ensureArray(ans.meds);
          const m = meds.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯") ? "Ù„Ø§ ÙŠØªÙ†Ø§ÙˆÙ„ Ø£Ø¯ÙˆÙŠØ© Ø«Ø§Ø¨ØªØ©" : meds.join("ØŒ ");
          const other = (ans.meds_other && !meds.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯")) ? `ØŒ Ø£Ø®Ø±Ù‰: ${ans.meds_other}` : "";
          return `Medications: ${m}${other}. Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…: ${ans.adherence||"ØºÙŠØ± Ù…ÙÙ‚ÙŠÙ‘Ù…"}.`;
        }
      },
      {
        id:"allergies",
        title:"Ù¥) Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©",
        questions:[
          {
            key:"allergy",
            label:"Ø§Ø®ØªØ± Ù…Ø§ ÙŠÙ†Ø·Ø¨Ù‚",
            type:"checkbox",
            options:["Ù„Ø§ ÙŠÙˆØ¬Ø¯","Ø¨Ù†Ø³Ù„ÙŠÙ†","Ù…Ø¶Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‡Ø§Ø¨ (NSAIDs)","Ø£ØºØ°ÙŠØ©","Ù„Ø§ØªÙÙƒØ³","Ø£Ø®Ø±Ù‰"],
            withOther:true,
            hasNone:true
          },
          {
            key:"allergyRxn",
            label:"Ù†ÙˆØ¹ Ø§Ù„ØªÙØ§Ø¹Ù„ (Ø¥Ù† ÙˆØ¬Ø¯)",
            type:"radio",
            options:["Ø·ÙØ­/Ø­ÙƒØ©","ØªÙˆØ±Ù‘Ù…/ÙˆØ°Ù…Ø© ÙˆØ¹Ø§Ø¦ÙŠØ©","Ø­Ø³Ø§Ø³ÙŠØ© Ù…ÙØ±Ø·Ø©","ØºÙŠØ± Ù…Ø­Ø¯Ø¯","Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚"],
            default:"Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚"
          }
        ],
        summarize(ans){
          const list = ensureArray(ans.allergy);
          if(list.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯")) return "Allergies: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø³ÙŠØ© Ù…Ø¹Ø±ÙˆÙØ© (NKDA/No known).";
          const other = ans.allergy_other ? `ØŒ Ø£Ø®Ø±Ù‰: ${ans.allergy_other}` : "";
          return `Allergies: ${list.join("ØŒ ")}${other}. Ù†ÙˆØ¹ Ø§Ù„ØªÙØ§Ø¹Ù„: ${ans.allergyRxn||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}.`;
        }
      },
      {
        id:"psh",
        title:"Ù¦) Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¬Ø±Ø§Ø­ÙŠØ© (PSH)",
        questions:[
          {
            key:"psh",
            label:"Ø§Ø®ØªØ± Ù…Ø§ ÙŠÙ†Ø·Ø¨Ù‚",
            type:"checkbox",
            options:["Ù„Ø§ ÙŠÙˆØ¬Ø¯","Ø§Ø³ØªØ¦ØµØ§Ù„ Ø²Ø§Ø¦Ø¯Ø©","Ø§Ø³ØªØ¦ØµØ§Ù„ Ù…Ø±Ø§Ø±Ø©","Ù‚ÙŠØµØ±ÙŠØ©","ÙØªØ§Ù‚","Ø¬Ø±Ø§Ø­Ø© Ù‚Ù„Ø¨ÙŠØ©","Ø£Ø®Ø±Ù‰"],
            withOther:true,
            hasNone:true
          }
        ],
        summarize(ans){
          const list = ensureArray(ans.psh);
          if(list.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯")) return "PSH: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©.";
          const other = ans.psh_other ? `ØŒ Ø£Ø®Ø±Ù‰: ${ans.psh_other}` : "";
          return `PSH: ${list.join("ØŒ ")}${other}.`;
        }
      },
      {
        id:"family",
        title:"Ù§) Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠ",
        questions:[
          {
            key:"fhx",
            label:"Ø£Ù…Ø±Ø§Ø¶ Ø¹Ø§Ø¦Ù„ÙŠØ©",
            type:"checkbox",
            options:["Ù„Ø§ ÙŠÙˆØ¬Ø¯","Ø³ÙƒØ±ÙŠ","Ø¶ØºØ· Ø¯Ù…","Ø£Ù…Ø±Ø§Ø¶ Ù‚Ù„Ø¨ÙŠØ© Ù…Ø¨ÙƒØ±Ø©","Ø³Ø±Ø·Ø§Ù†Ø§Øª","Ø£Ù…Ø±Ø§Ø¶ ÙˆØ±Ø§Ø«ÙŠØ©","Ø£Ø®Ø±Ù‰"],
            withOther:true,
            hasNone:true
          }
        ],
        summarize(ans){
          const list = ensureArray(ans.fhx);
          if(list.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯")) return "FHx: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ§Ø±ÙŠØ® Ø¹Ø§Ø¦Ù„ÙŠ Ù…Ù‡Ù….";
          const other = ans.fhx_other ? `ØŒ Ø£Ø®Ø±Ù‰: ${ans.fhx_other}` : "";
          return `FHx: ${list.join("ØŒ ")}${other}.`;
        }
      },
      {
        id:"social",
        title:"Ù¨) Ø§Ù„Ø¹Ø§Ø¯Ø§Øª ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© (Social)",
        questions:[
          {
            key:"smoke",
            label:"Ø§Ù„ØªØ¯Ø®ÙŠÙ†",
            type:"radio",
            options:["ØºÙŠØ± Ù…Ø¯Ø®Ù†","Ù…Ø¯Ø®Ù† Ø­Ø§Ù„ÙŠ","Ù…ØªÙˆÙ‚Ù"],
            default:"ØºÙŠØ± Ù…Ø¯Ø®Ù†"
          },
          {
            key:"occupation",
            label:"Ø§Ù„Ø¹Ù…Ù„/Ø§Ù„Ø¯Ø±Ø§Ø³Ø©",
            type:"select",
            options:["Ø·Ø§Ù„Ø¨","Ù…ÙˆØ¸Ù Ù…ÙƒØªØ¨","Ø¹Ù…Ù„ Ø¨Ø¯Ù†ÙŠ","Ù‚Ø·Ø§Ø¹ ØµØ­ÙŠ","Ù„Ø§ ÙŠØ¹Ù…Ù„","Ø£Ø®Ø±Ù‰"],
            withOther:true
          },
          {
            key:"activity",
            label:"Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ",
            type:"radio",
            options:["Ø®Ø§Ù…Ù„","Ù…ØªÙˆØ³Ø·","Ù†Ø´ÙØ·"],
            default:"Ù…ØªÙˆØ³Ø·"
          },
          {
            key:"caffeine",
            label:"Ø§Ù„ÙƒØ§ÙÙŠÙŠÙ†",
            type:"radio",
            options:["Ù‚Ù„ÙŠÙ„","Ù…ØªÙˆØ³Ø·","ÙƒØ«ÙŠØ±","Ù„Ø§ ÙŠØªÙ†Ø§ÙˆÙ„"],
            default:"Ù…ØªÙˆØ³Ø·"
          }
        ],
        summarize(ans){
          const occ = ans.occupation === "Ø£Ø®Ø±Ù‰" ? (ans.occupation_other || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯") : (ans.occupation || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");
          return `Social: ØªØ¯Ø®ÙŠÙ†: ${ans.smoke||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"} | Ù†Ø´Ø§Ø·: ${ans.activity||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"} | ÙƒØ§ÙÙŠÙŠÙ†: ${ans.caffeine||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"} | Ø¹Ù…Ù„/Ø¯Ø±Ø§Ø³Ø©: ${occ}.`;
        }
      },
      {
        id:"imms",
        title:"Ù©) Ø§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª",
        questions:[
          {
            key:"vacc",
            label:"Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¹ÙŠÙ…",
            type:"radio",
            options:["Ù…ÙƒØªÙ…Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø±","ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"],
            default:"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
          },
          {
            key:"extraVacc",
            label:"ØªØ·Ø¹ÙŠÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø£Ø®ÙˆØ°Ø©",
            type:"checkbox",
            options:["Ø§Ù†ÙÙ„ÙˆÙ†Ø²Ø§ Ù…ÙˆØ³Ù…ÙŠØ©","ÙƒÙˆÙÙŠØ¯-19 (Ø¢Ø®Ø± Ø³Ù†Ø©)","Ø§Ù„ÙƒØ²Ø§Ø²","Ø§Ù„ØªÙ‡Ø§Ø¨ ÙƒØ¨Ø¯ B","Ù„Ø§ ÙŠÙˆØ¬Ø¯"],
            hasNone:true
          }
        ],
        summarize(ans){
          const base = ans.vacc || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
          const extra = ensureArray(ans.extraVacc);
          const ext = extra.length ? (extra.includes("Ù„Ø§ ÙŠÙˆØ¬Ø¯") ? "" : `Ø› Ø¥Ø¶Ø§ÙÙŠØ©: ${extra.join("ØŒ ")}`) : "";
          return `Immunization: ${base}${ext}.`;
        }
      },
      {
        id:"gyn",
        title:"Ù¡Ù ) ØªØ§Ø±ÙŠØ® Ù†Ø³Ø§Ø¦ÙŠ/ØªÙˆÙ„ÙŠØ¯ÙŠ (ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¥Ù†Ø§Ø«)",
        visibleIf:(answers)=> answers.gender === "Ø£Ù†Ø«Ù‰" && Number(state.age) >= 12 && Number(state.age) <= 55,
        questions:[
          {
            key:"preg",
            label:"Ø­Ù…Ù„ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŸ",
            type:"radio",
            options:["Ù„Ø§","Ù†Ø¹Ù…","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"],
            default:"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
          },
          {
            key:"lmp",
            label:"Ø¢Ø®Ø± Ø¯ÙˆØ±Ø© Ø´Ù‡Ø±ÙŠØ©",
            type:"radio",
            options:["Ø£Ù‚Ù„ Ù…Ù† 4 Ø£Ø³Ø§Ø¨ÙŠØ¹","4â€“8 Ø£Ø³Ø§Ø¨ÙŠØ¹","Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ù‡Ø±ÙŠÙ†","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚"],
            default:"Ù„Ø§ ÙŠÙ†Ø·Ø¨Ù‚"
          }
        ],
        summarize(ans){
          if(!(state.answers.gender === "Ø£Ù†Ø«Ù‰" && state.age >= 12 && state.age <=55)) return "";
          return `Gyn/Obs: Ø­Ù…Ù„: ${ans.preg||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"} | LMP: ${ans.lmp||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}.`;
        }
      },
      {
        id:"ros",
        title:"Ù¡Ù¡) Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (ROS)",
        questions:[
          {
            key:"ros_general",
            label:"Ø¹Ø§Ù…",
            type:"checkbox",
            options:["Ù„Ø§ Ø´ÙƒØ§ÙˆÙ‰","Ø­Ù…Ù‘Ù‰","ØªØ¹Ø±Ù‘Ù‚ Ù„ÙŠÙ„ÙŠ","Ù†Ù‚Øµ ÙˆØ²Ù†","Ø¥Ø±Ù‡Ø§Ù‚"],
            hasNone:true
          },
          {
            key:"ros_cardio",
            label:"Ù‚Ù„Ø¨ÙŠ ÙˆØ¹Ø§Ø¦ÙŠ",
            type:"checkbox",
            options:["Ù„Ø§ Ø´ÙƒØ§ÙˆÙ‰","Ø£Ù„Ù… ØµØ¯Ø±ÙŠ","Ø®ÙÙ‚Ø§Ù†","ØªÙˆØ±Ù… Ø£Ø·Ø±Ø§Ù","Ø¥ØºÙ…Ø§Ø¡"],
            hasNone:true
          },
          {
            key:"ros_resp",
            label:"ØªÙ†ÙØ³ÙŠ",
            type:"checkbox",
            options:["Ù„Ø§ Ø´ÙƒØ§ÙˆÙ‰","Ø³Ø¹Ø§Ù„","Ø¶ÙŠÙ‚ ØªÙ†ÙØ³","ØµÙÙŠØ±","Ø¨Ù„ØºÙ…"],
            hasNone:true
          },
          {
            key:"ros_gi",
            label:"Ù‡Ø¶Ù…ÙŠ",
            type:"checkbox",
            options:["Ù„Ø§ Ø´ÙƒØ§ÙˆÙ‰","Ø£Ù„Ù… Ø¨Ø·Ù†ÙŠ","ØºØ«ÙŠØ§Ù†/Ù‚ÙŠØ¡","Ø¥Ø³Ù‡Ø§Ù„","Ø¥Ù…Ø³Ø§Ùƒ","Ø­Ø±Ù‚Ø©/Ø§Ø±ØªØ¬Ø§Ø¹"],
            hasNone:true
          },
          {
            key:"ros_neuro",
            label:"Ø¹ØµØ¨ÙŠ",
            type:"checkbox",
            options:["Ù„Ø§ Ø´ÙƒØ§ÙˆÙ‰","ØµØ¯Ø§Ø¹","Ø¯ÙˆØ®Ø©","Ø¶Ø¹Ù/Ø®Ø¯Ø±","Ø§Ø®ØªÙ„Ø§Ø¬Ø§Øª"],
            hasNone:true
          }
        ],
        summarize(ans){
          function line(key, name){
            const v = ensureArray(ans[key]);
            return v.includes("Ù„Ø§ Ø´ÙƒØ§ÙˆÙ‰") ? `${name}: Ù„Ø§ Ø´ÙƒØ§ÙˆÙ‰.` : `${name}: ${v.join("ØŒ ")}.`;
          }
          return `ROS:
- ${line("ros_general","Ø¹Ø§Ù…")}
- ${line("ros_cardio","Ù‚Ù„Ø¨ÙŠ")}
- ${line("ros_resp","ØªÙ†ÙØ³ÙŠ")}
- ${line("ros_gi","Ù‡Ø¶Ù…ÙŠ")}
- ${line("ros_neuro","Ø¹ØµØ¨ÙŠ")}`;
        }
      },
    ];

    // ============ Build UI ============
    const dynamicRoot = byId('dynamicSections');
    const stepper = byId('stepper');

    function buildStepper(){
      stepper.innerHTML = '';
      const steps = [
        {id:'step-age', label:'Ø§Ù„Ø¹Ù…Ø±'},
        ...SCHEMA.map(s => ({id:s.id, label: s.title.replace(/^\d+\)\s*/,'').slice(0,18) + (s.title.length>18?'â€¦':'')}))
      ];
      steps.forEach((st,i)=>{
        const b = document.createElement('div');
        b.className = 'step' + (i===0?' active':'');
        b.dataset.target = st.id;
        b.textContent = `${i+1}. ${st.label}`;
        stepper.appendChild(b);
      });
    }

    function buildSections(){
      dynamicRoot.innerHTML = '';
      SCHEMA.forEach(section=>{
        const sec = document.createElement('section');
        sec.className = 'section';
        sec.id = section.id;
        const h = document.createElement('h3');
        h.textContent = section.title;
        sec.appendChild(h);

        section.questions.forEach(q=>{
          const block = document.createElement('div');
          block.className = 'row';
          const label = document.createElement('div');
          label.innerHTML = `<div class="muted" style="margin-bottom:8px">${q.label}</div>`;
          block.appendChild(label);

          const group = document.createElement('div');
          group.className = 'row';
          group.dataset.group = q.key;

          if(q.type === 'radio' || q.type === 'checkbox'){
            q.options.forEach(opt=>{
              const id = `${section.id}-${q.key}-${kebab(String(opt))}`;
              const wrap = document.createElement('label');
              wrap.className = 'chip';
              const input = document.createElement('input');
              input.type = q.type;
              input.name = q.key + (q.type==='checkbox' ? '[]' : '');
              input.value = opt;
              input.id = id;
              if(q.hasNone && opt === "Ù„Ø§ ÙŠÙˆØ¬Ø¯"){ input.setAttribute('data-none',''); }
              input.addEventListener('change', ()=> {
                if(q.type==='radio'){
                  state.answers[q.key] = input.value;
                } else {
                  // checkboxes
                  const all = [...group.querySelectorAll('input[type=checkbox]')].filter(c=>c.checked).map(c=>c.value);
                  state.answers[q.key] = all;
                }
                renderNote();
              });
              wrap.appendChild(input);
              const span = document.createElement('span');
              span.textContent = opt;
              wrap.appendChild(input);
              wrap.appendChild(span);
              group.appendChild(wrap);
            });

          } else if(q.type === 'select'){
            const sel = document.createElement('select');
            sel.id = `${section.id}-${q.key}`;
            q.options.forEach(opt=>{
              const o = document.createElement('option');
              o.value = opt;
              o.textContent = opt;
              sel.appendChild(o);
            });
            sel.addEventListener('change', ()=>{
              state.answers[q.key] = sel.value;
              // toggle 'other' input
              const otherWrap = byId(`${section.id}-${q.key}-other-wrap`);
              if(otherWrap) otherWrap.classList.toggle('hidden', sel.value !== 'Ø£Ø®Ø±Ù‰');
              renderNote();
            });
            group.appendChild(sel);
          }

          block.appendChild(group);

          // Optional "other" text for select/checkbox groups
          if(q.withOther){
            const otherWrap = document.createElement('div');
            otherWrap.id = `${section.id}-${q.key}-other-wrap`;
            otherWrap.className = 'grid-two ' + 'hidden';
            otherWrap.innerHTML = `
              <div class="muted">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯:</div>
              <input type="text" id="${section.id}-${q.key}-other" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ù…Ø®ØªØµØ±â€¦" />
            `;
            block.appendChild(otherWrap);
            block.addEventListener('change', ()=>{
              const needsOther =
                (q.type==='select' && state.answers[q.key]==='Ø£Ø®Ø±Ù‰') ||
                (q.type!=='select' && ensureArray(state.answers[q.key]).includes('Ø£Ø®Ø±Ù‰'));
              otherWrap.classList.toggle('hidden', !needsOther);
            });
            // listen typing
            block.addEventListener('input', (e)=>{
              const inp = byId(`${section.id}-${q.key}-other`);
              if(e.target===inp){
                state.answers[`${q.key}_other`] = inp.value.trim();
                renderNote();
              }
            });
          }

          sec.appendChild(block);
        });

        dynamicRoot.appendChild(sec);

        // Initialize defaults
        section.questions.forEach(q=>{
          if(q.type==='radio' && q.default){
            state.answers[q.key] = q.default;
            // Check the default radio visually
            const def = $(`input[type=radio][name="${q.key}"][value="${q.default}"]`, sec);
            if(def) def.checked = true;
          }
        });

        handleNoneBehavior(sec);
      });

      // Visibility rules (e.g., Gyn)
      applyVisibilityRules();
    }

    function applyVisibilityRules(){
      SCHEMA.forEach(section=>{
        if(section.visibleIf){
          const visible = !!section.visibleIf(state.answers);
          const el = byId(section.id);
          if(el) el.classList.toggle('hidden', !visible);
        }
      });
    }

    // ============ Note Rendering ============
    function renderNote(){
      applyVisibilityRules();

      const parts = [];
      // Header
      parts.push(`Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø¶ÙŠ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)
Ø§Ù„Ø¹Ù…Ø±: ${state.age ?? "ØºÙŠØ± Ù…Ø¯Ø®Ù„"} Ø³Ù†Ø©
${"â€”".repeat(30)}`);

      // sections summaries
      SCHEMA.forEach(section=>{
        // if section is hidden by visibleIf => may skip summary (unless summarize returns empty)
        if(section.visibleIf && !section.visibleIf(state.answers)) {
          // do nothing
        }
        const s = section.summarize(state.answers) || "";
        if(s.trim()) parts.push(s.trim());
      });

      const noteText = parts.join("\n");
      byId('noteBox').textContent = noteText;

      // Update stepper visual
      const steps = $$('.step', stepper);
      steps.forEach(st=>{
        const target = st.dataset.target;
        const done = (target === 'step-age') ? !!state.age : !!byId(target);
        st.classList.toggle('active', done);
      });
    }

    // ============ Age Gate ============
    byId('confirmAge').addEventListener('click', ()=>{
      const val = Number(byId('age').value);
      const ok = Number.isFinite(val) && val>=0 && val<=120;
      byId('ageWarn').classList.toggle('hidden', ok);
      if(!ok){ byId('ageWarn').classList.remove('hidden'); return; }
      state.age = val;
      // Reveal dynamic sections & actions
      byId('dynamicSections').classList.remove('hidden');
      byId('finalActions').classList.remove('hidden');
      // Build once if empty
      if(!byId(SCHEMA[0].id)){ buildSections(); }
      renderNote();
      // Scroll to first section
      byId(SCHEMA[0].id).scrollIntoView({behavior:'smooth', block:'start'});
    });

    // ============ Actions ============
    byId('copyNote').addEventListener('click', async ()=>{
      const text = byId('noteBox').textContent;
      try{
        await navigator.clipboard.writeText(text);
        flash('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…');
      }catch(e){
        flash('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ù†Øµ ÙˆØ§Ù†Ø³Ø®Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§.', true);
      }
    });

    byId('downloadTxt').addEventListener('click', ()=>{
      const blob = new Blob([byId('noteBox').textContent], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'medical-history-note.txt';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    byId('printNote').addEventListener('click', ()=> window.print());

    function flash(msg, isErr=false){
      const b = document.createElement('div');
      b.textContent = msg;
      b.style.position='fixed';
      b.style.insetInlineEnd='20px';
      b.style.bottom='20px';
      b.style.padding='10px 12px';
      b.style.border='1px solid var(--border)';
      b.style.borderRadius='12px';
      b.style.background=isErr?'#7f1d1d':'#064e3b';
      b.style.color='#fff';
      b.style.boxShadow= '0 10px 30px rgba(0,0,0,.35)';
      document.body.appendChild(b);
      setTimeout(()=>b.remove(),2000);
    }

    // Initial UI
    buildStepper();
    renderNote();

    // Keyboard: Enter on age field
    byId('age').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ byId('confirmAge').click(); }
    });
  </script>
</body>
</html>